<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springbootportfolio.springbootportfolio.mapper.FindMemberBoardMapper">
    <!-- 유저이름,제목,게임종류,본문을 검색조건에 따라 검색-->
    <select id="selectFindMeberBoard" parameterType="map" resultType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        SELECT
            tn_name,
            title,
            nickname,
            match_type,
            created_at,
            seq,
            views,
            (
                select 
                    count(post_seq) 
                from 
                    findmemberboardcomment f2 
                where 
                    f.seq = f2.post_seq) as commentCount
        FROM  
            findmemberboard f
        <where>
            <if test="searchType == 'nickname' or  searchType == '' ">
                OR nickname like concat('%', #{searchText}, '%')
            </if>
            <if test="searchType == 'title' or searchType == '' ">
                OR title like concat('%', #{searchText}, '%')
            </if>
            <if test="matchType != null and matchType != '' ">
                AND match_type like concat('%', #{matchType}, '%')
            </if>
        </where>
        ORDER BY created_at DESC
        limit #{pageSize} offset #{offset}
    </select>
    <!-- 검색한 게시물의 총 수-->
    <select id="countSelectFindMeberBoard" parameterType="map" resultType="int">
        SELECT
            count(*)
        FROM  
            findmemberboard
        <where>
            <if test="nickname != null and nickname != '' ">
                AND nickname like concat('%', #{nickname}, '%')
            </if>
            <if test="title != null and title != '' ">
                AND title like concat('%', #{title}, '%')
            </if>
            <if test="matchType != null and matchType != '' ">
                AND match_type like concat('%', #{matchType}, '%')
            </if>
        </where>
    </select>
    <!-- 최근 작성된 상위10개의 게시물을 검색-->
    <select id="getRecentTenFindMemberBoard" resultType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        select 
            seq,
            title,
            nickname,
            views,
            (   select 
                    count(post_seq) 
                from 
                    findmemberboardcomment f2 
                where 
                    f.seq = f2.post_seq) as commentCount 
            from
                findmemberboard f 
            order by 
                created_at desc limit 10
    </select>
    <!-- 선택된 게시물의 상세페이지-->
    <select id="selectFindMemberBoardDetail" parameterType="int" resultType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        select 
            seq,
            nickname,
            title,
            content,
            views,
            match_type,
            created_at,
            ( select 
                count(post_seq) 
              from 
                findmemberboardcomment f2 
              where 
                f2.post_seq = f.seq) as commentCount
        from 
            findmemberBoard f
        where 
            seq = #{_parameter}
    </select>
    <!-- 선택된 게시물의 댓글 검색-->
    <select id="selectFindMemberBoardDetailComment" parameterType="map" resultType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        select 
            seq,
            content,
            nickname,
            created_at 
        from 
            findMemberBoardComment 
        where 
            post_seq  = #{seq}
        order by created_at desc
        limit #{limit} offset #{offset}
    </select>
    <!-- 선택된 게시물의 댓글 수-->
    <select id="selectFindMemberBoardDetailCommentCount" parameterType="int" resultType="int">
        select 
            count(*)
        from 
            findMemberBoardComment 
        where 
            post_seq  = #{_parameter}
    </select>
    <!-- 게시물 작성-->
    <insert id="writeFindMemberBoardDetail" parameterType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        insert into 
            findmemberboard
            (tn_name,nickname,match_type,title,content) 
            values
            (#{tnName},#{nickname},#{matchType},#{title},#{content})
    </insert>
    <!-- 게시물 수정-->
    <update id="updateFindMemberBoardDetail" parameterType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        update 
            findmemberboard 
        set 
            title = #{title},
            content = #{content},
            match_type = #{matchType} 
        where 
            seq = #{seq}
    </update>
    <!-- 조회수 증가-->
    <update id="findMemberBoardIncreaseViews">
        update 
            findmemberboard 
        set 
            views = views + 1,
            updated_at  = updated_at 
        where  
            seq = #{_parameter}
    </update>
    <!-- 게시물 삭제-->
    <delete id="deleteFindMemberBoardDetail" parameterType="int">
        delete 
        from 
            findmemberboard 
        where 
            seq = #{_parameter}
    </delete>

    <!-- 매칭구인게시판 댓글 -->
    <insert id="writeFindMemberBoardDetailComment" parameterType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        insert 
            into 
        findmemberboardcomment
            (post_seq,content,nickname) 
        values 
            (#{seq},#{content},#{nickname});
    </insert>

    <!-- 댓글 수정-->
    <update id="updateFindMemberBoardDetailComment" parameterType="com.springbootportfolio.springbootportfolio.dto.FindMemberBoardDto">
        update 
            findmemberboardcomment  
        set 
            content = #{content} 
        where 
            seq = #{seq}
    </update>
    <!-- 댓글 삭제-->
    <delete id="deleteFindMemberBoardDetailComment" parameterType="int">
        delete 
            from 
                findmemberboardcomment 
        where 
            seq = #{_parameter}
    </delete>
</mapper>